
import chisel3._
import chiseltest._
import org.scalatest.freespec.AnyFreeSpec

class SearchTopTest extends AnyFreeSpec with ChiselScalatestTester {
  "Specification" in {
    test(new searchTop()) { dut =>

      // Example current MB
      //val curData = Array(183, 180, 190, 155, 125, 127, 130, 131, 131, 131, 132, 131, 131, 131, 126, 163, 141, 143, 142, 100, 153, 144, 130, 131, 130, 132, 131, 131, 130, 133, 174, 191, 129, 130, 130, 124, 104, 89, 158, 146, 131, 131, 130, 132, 133, 171, 189, 114, 144, 135, 131, 132, 123, 121, 104, 161, 185, 143, 132, 170, 180, 114, 123, 116, 73, 125, 135, 131, 132, 132, 123, 137, 183, 186, 179, 115, 96, 109, 126, 128, 57, 72, 72, 125, 135, 131, 130, 169, 188, 190, 117, 106, 119, 129, 119, 68, 51, 61, 60, 71, 72, 125, 104, 166, 120, 121, 124, 127, 120, 115, 66, 44, 71, 50, 62, 62, 60, 72, 146, 142, 123, 126, 129, 119, 67, 53, 46, 41, 172, 69, 52, 62, 56, 116, 116, 131, 142, 122, 69, 54, 46, 43, 41, 45, 155, 163, 111, 49, 53, 126, 106, 53, 66, 60, 46, 41, 43, 43, 28, 109, 124, 152, 168, 167, 110, 79, 92, 43, 52, 46, 43, 43, 28, 106, 79, 124, 70, 72, 130, 181, 178, 167, 172, 105, 62, 46, 41, 29, 56, 125, 115, 66, 61, 60, 67, 157, 191, 163, 178, 118, 49, 28, 59, 113, 132, 71, 53, 46, 61, 62, 59, 153, 186, 153, 149, 144, 158, 132, 128, 123, 134, 43, 37, 46, 49, 59, 59, 154, 128, 77, 125, 146, 154, 126, 116, 115, 84, 28, 38, 43, 113, 47, 55, 158, 118, 64, 68, 72, 128, 74, 51, 103, 77, 28, 38, 32)
      //val curData = Array(152, 141, 143, 142, 100, 153, 144, 130, 131, 130, 132, 131, 131, 130, 133, 174, 148, 129, 130, 130, 124, 104, 89, 158, 146, 131, 131, 130, 132, 133, 171, 189, 132, 144, 135, 131, 132, 123, 121, 104, 161, 185, 143, 132, 170, 180, 114, 123, 78, 73, 125, 135, 131, 132, 132, 123, 137, 183, 186, 179, 115, 96, 109, 126, 62, 57, 72, 72, 125, 135, 131, 130, 169, 188, 190, 117, 106, 119, 129, 119, 49, 51, 61, 60, 71, 72, 125, 104, 166, 120, 121, 124, 127, 120, 115, 66, 167, 71, 50, 62, 62, 60, 72, 146, 142, 123, 126, 129, 119, 67, 53, 46, 180, 172, 69, 52, 62, 56, 116, 116, 131, 142, 122, 69, 54, 46, 43, 41, 150, 155, 163, 111, 49, 53, 126, 106, 53, 66, 60, 46, 41, 43, 43, 28, 72, 124, 152, 168, 167, 110, 79, 92, 43, 52, 46, 43, 43, 28, 106, 79, 60, 70, 72, 130, 181, 178, 167, 172, 105, 62, 46, 41, 29, 56, 125, 115, 60, 61, 60, 67, 157, 191, 163, 178, 118, 49, 28, 59, 113, 132, 71, 53, 48, 61, 62, 59, 153, 186, 153, 149, 144, 158, 132, 128, 123, 134, 43, 37, 49, 49, 59, 59, 154, 128, 77, 125, 146, 154, 126, 116, 115, 84, 28, 38, 167, 113, 47, 55, 158, 118, 64, 68, 72, 128, 74, 51, 103, 77, 28, 38, 135, 165, 108, 146, 186, 116, 60, 58, 60, 69, 50, 43, 101, 82, 63, 69)
      val curData = Array(212, 213, 213, 220, 220, 218, 222, 219, 218, 224, 231, 235, 235, 235, 233, 233, 237, 231, 232, 218, 207, 198, 186, 173, 151, 141, 125, 126, 130, 133, 128, 113, 99, 96, 98, 104, 128, 121, 108, 129, 133, 132, 145, 157, 160, 170, 170, 186, 133, 144, 98, 148, 165, 139, 150, 164, 176, 185, 218, 218, 219, 231, 212, 208, 84, 82, 58, 46, 30, 24, 39, 29, 38, 44, 53, 39, 37, 41, 38, 30, 19, 31, 41, 43, 50, 49, 48, 56, 51, 43, 28, 33, 37, 31, 38, 38, 45, 37, 39, 42, 37, 37, 31, 34, 30, 28, 31, 34, 32, 30, 31, 32, 39, 40, 39, 32, 29, 31, 27, 23, 22, 27, 27, 25, 24, 22, 22, 24, 22, 26, 24, 25, 25, 19, 18, 15, 20, 21, 18, 17, 15, 19, 19, 19, 0, 0, 0, 0, 3, 1, 2, 3, 3, 3, 8, 10, 18, 17, 18, 19, 29, 34, 38, 40, 32, 44, 54, 49, 29, 21, 11, 8, 4, 4, 3, 5, 175, 180, 170, 165, 188, 204, 234, 226, 217, 208, 179, 154, 133, 94, 56, 16, 244, 232, 240, 239, 244, 250, 250, 250, 250, 251, 250, 251, 251, 242, 235, 205, 217, 208, 213, 209, 238, 250, 251, 251, 251, 251, 252, 250, 246, 245, 247, 248, 209, 199, 198, 201, 235, 245, 244, 244, 247, 247, 247, 250, 250, 250, 250, 249, 207, 193, 202, 206, 227, 242, 242, 240, 224, 225, 241, 243, 238, 244, 250, 251)
      for (i <- curData.indices) {
        dut.io.cur_data_in(i).poke(curData(i).U)
      }

      // Example search area
      //val searchAreaData = Array(0, 1, 73, 129, 129, 96, 146, 191, 150, 120, 126, 131, 131, 131, 131, 131, 131, 142, 145, 184, 183, 179, 178, 177, 172, 191, 192, 109, 115, 110, 102, 13, 72, 110, 120, 98, 150, 173, 186, 194, 145, 120, 128, 131, 131, 131, 131, 131, 132, 130, 129, 179, 193, 193, 193, 194, 193, 192, 192, 170, 100, 126, 127, 105, 128, 132, 96, 143, 148, 141, 137, 107, 158, 145, 128, 131, 131, 131, 131, 131, 131, 132, 131, 179, 193, 191, 192, 189, 115, 134, 184, 192, 173, 175, 102, 125, 182, 180, 137, 129, 130, 129, 128, 115, 134, 136, 98, 118, 132, 132, 132, 132, 131, 169, 180, 189, 192, 192, 190, 115, 106, 118, 131, 138, 111, 179, 171, 100, 163, 132, 120, 130, 130, 131, 131, 130, 129, 124, 121, 95, 158, 183, 181, 181, 141, 139, 136, 179, 192, 189, 150, 115, 126, 129, 127, 121, 120, 139, 141, 92, 122, 156, 178, 146, 128, 130, 131, 131, 131, 129, 131, 124, 175, 194, 193, 154, 132, 129, 128, 138, 107, 131, 133, 129, 131, 131, 131, 129, 131, 130, 129, 114, 128, 133, 111, 90, 88, 120, 132, 130, 130, 132, 132, 169, 189, 153, 140, 132, 130, 131, 131, 129, 87, 83, 122, 132, 131, 131, 131, 131, 131, 131, 131, 130, 121, 136, 123, 113, 152, 179, 146, 131, 131, 169, 183, 152, 140, 132, 129, 131, 131, 131, 132, 131, 124, 86, 88, 123, 131, 131, 132, 131, 131, 131, 132, 130, 69, 123, 137, 130, 134, 108, 156, 183, 180, 190, 155, 125, 127, 130, 131, 131, 131, 132, 131, 131, 131, 126, 163, 107, 124, 131, 131, 131, 131, 130, 116, 66, 61, 71, 73, 122, 134, 159, 152, 141, 143, 142, 100, 153, 144, 130, 131, 130, 132, 131, 131, 130, 133, 174, 191, 175, 176, 106, 123, 131, 117, 67, 55, 44, 57, 59, 60, 69, 124, 178, 148, 129, 130, 130, 124, 104, 89, 158, 146, 131, 131, 130, 132, 133, 171, 189, 114, 98, 101, 159, 142, 69, 54, 44, 43, 40, 78, 47, 62, 58, 122, 122, 132, 144, 135, 131, 132, 123, 121, 104, 161, 185, 143, 132, 170, 180, 114, 123, 116, 111, 111, 125, 87, 48, 42, 44, 43, 26, 120, 47, 48, 54, 121, 111, 78, 73, 125, 135, 131, 132, 132, 123, 137, 183, 186, 179, 115, 96, 109, 126, 128, 117, 68, 102, 75, 46, 44, 45, 32, 109, 142, 156, 113, 47, 115, 114, 62, 57, 72, 72, 125, 135, 131, 130, 169, 188, 190, 117, 106, 119, 129, 119, 68, 54, 47, 103, 76, 30, 27, 113, 125, 140, 120, 154, 144, 154, 177, 122, 49, 51, 61, 60, 71, 72, 125, 104, 166, 120, 121, 124, 127, 120, 115, 66, 44, 42, 43, 99, 80, 113, 124, 136, 123, 134, 58, 73, 123, 152, 177, 177, 167, 71, 50, 62, 62, 60, 72, 146, 142, 123, 126, 129, 119, 67, 53, 46, 41, 39, 40, 57, 119, 140, 121, 66, 58, 126, 47, 61, 70, 72, 127, 155, 180, 172, 69, 52, 62, 56, 116, 116, 131, 142, 122, 69, 54, 46, 43, 41, 45, 30, 60, 117, 119, 67, 53, 43, 47, 125, 42, 62, 61, 60, 68, 123, 150, 155, 163, 111, 49, 53, 126, 106, 53, 66, 60, 46, 41, 43, 43, 28, 109, 126, 110, 116, 64, 43, 43, 44, 48, 125, 66, 59, 60, 62, 61, 70, 72, 124, 152, 168, 167, 110, 79, 92, 43, 52, 46, 43, 43, 28, 106, 79, 124, 123, 66, 53, 44, 44, 44, 42, 51, 128, 120, 52, 52, 61, 62, 61, 60, 70, 72, 130, 181, 178, 167, 172, 105, 62, 46, 41, 29, 56, 125, 115, 66, 53, 45, 43, 44, 40, 39, 29, 114, 139, 139, 167, 170, 74, 47, 57, 60, 61, 60, 67, 157, 191, 163, 178, 118, 49, 28, 59, 113, 132, 71, 53, 46, 43, 44, 44, 43, 29, 61, 67, 127, 117, 70, 127, 176, 117, 49, 32, 48, 61, 62, 59, 153, 186, 153, 149, 144, 158, 132, 128, 123, 134, 43, 37, 46, 44, 42, 47, 32, 109, 128, 108, 62, 52, 60, 67, 73, 118, 158, 111, 49, 49, 59, 59, 154, 128, 77, 125, 146, 154, 126, 116, 115, 84, 28, 38, 43, 43, 31, 110, 127, 116, 66, 53, 44, 43, 61, 60, 59, 66, 130, 168, 167, 113, 47, 55, 158, 118, 64, 68, 72, 128, 74, 51, 103, 77, 28, 38, 32, 110, 127, 121, 133, 65, 42, 42, 43, 41, 48, 57, 59, 58, 121, 118, 135, 165, 108, 146, 186, 116, 60, 58, 60, 69, 50, 43, 101, 82, 63, 69, 115, 136, 120, 114, 81, 44, 39, 38, 39, 27, 113, 50, 47, 55, 121, 109, 69, 72, 121, 170, 185, 120, 45, 47, 60, 61, 48, 42, 101, 130, 82, 115, 119, 66, 53, 104, 75, 41, 40, 30, 60, 67, 170, 163, 112, 43, 112, 111, 60, 56, 68, 73, 128, 170, 112, 48, 51, 60, 49, 31, 115, 142, 65, 52, 53, 44, 44, 98, 73, 28, 61, 114, 126, 121, 165, 171, 171, 107, 147, 122, 43, 46, 59, 59, 65, 129, 166, 168, 110, 44, 61, 113, 134, 117, 56, 41, 44, 43, 39, 54, 68, 67, 117, 130, 110, 59, 70, 114, 165, 170, 173, 174, 67, 47, 55, 57, 60, 67, 73, 132, 170, 109, 117, 118, 67, 50, 45, 43, 41, 40, 30, 108, 127, 125, 110, 58, 46, 43, 52, 53, 114, 160, 171, 179, 109, 86, 51, 49, 58, 59, 59, 66, 134, 172, 99, 51, 43, 42, 42, 40, 29, 61, 114, 134, 113, 107, 57, 39, 37, 37, 35, 40, 59, 63, 115, 160, 111, 143, 167, 110, 45, 49, 58, 58, 125, 178, 94, 40, 40, 38, 25, 59, 114, 126, 128, 109, 56, 46, 40, 36, 19, 18, 13, 35, 46, 51, 58, 63, 109, 162, 172, 169, 104, 42, 32, 50, 125, 177, 94, 26, 20, 26, 58, 116, 130, 110, 60, 47, 40, 37, 36, 21, 14, 38)
      val searchAreaData = Array(212, 211, 217, 220, 216, 214, 214, 214, 214, 215, 213, 212, 213, 210, 209, 211, 203, 199, 202, 204, 203, 205, 200, 199, 203, 202, 199, 202, 204, 197, 197, 199, 215, 213, 214, 218, 211, 210, 212, 214, 213, 215, 210, 210, 212, 213, 209, 207, 212, 216, 208, 200, 202, 203, 202, 200, 199, 199, 201, 203, 201, 198, 199, 200, 217, 214, 214, 213, 213, 214, 211, 211, 213, 217, 214, 211, 212, 210, 206, 207, 209, 216, 214, 206, 205, 205, 203, 202, 201, 201, 200, 200, 199, 200, 200, 199, 218, 218, 217, 214, 214, 217, 214, 214, 212, 213, 218, 211, 209, 212, 210, 208, 206, 206, 208, 207, 205, 206, 203, 201, 203, 205, 200, 201, 201, 200, 201, 199, 216, 217, 219, 217, 218, 215, 216, 216, 215, 215, 213, 209, 210, 212, 206, 208, 212, 208, 206, 209, 208, 205, 204, 200, 205, 206, 203, 198, 201, 201, 203, 202, 213, 208, 215, 215, 217, 218, 221, 218, 218, 216, 212, 210, 216, 212, 209, 210, 213, 212, 210, 206, 206, 211, 209, 207, 207, 204, 205, 202, 201, 201, 201, 200, 209, 204, 207, 210, 213, 218, 215, 222, 222, 219, 218, 216, 212, 212, 211, 208, 207, 208, 210, 209, 206, 208, 207, 209, 207, 203, 205, 203, 201, 200, 201, 201, 195, 193, 200, 199, 208, 208, 217, 222, 213, 212, 213, 213, 220, 220, 218, 222, 219, 218, 224, 231, 235, 235, 235, 233, 233, 234, 234, 235, 230, 228, 220, 210, 211, 200, 212, 221, 226, 224, 231, 234, 237, 237, 231, 232, 218, 207, 198, 186, 173, 151, 141, 125, 126, 130, 133, 128, 113, 99, 91, 94, 97, 86, 96, 98, 223, 203, 184, 155, 143, 138, 111, 97, 106, 99, 96, 98, 104, 128, 121, 108, 129, 133, 132, 145, 157, 160, 170, 170, 186, 187, 178, 193, 201, 210, 235, 250, 68, 59, 53, 32, 37, 45, 94, 93, 80, 133, 144, 98, 148, 165, 139, 150, 164, 176, 185, 218, 218, 219, 231, 212, 208, 210, 204, 201, 210, 222, 196, 180, 39, 52, 60, 69, 82, 82, 107, 94, 70, 84, 82, 58, 46, 30, 24, 39, 29, 38, 44, 53, 39, 37, 41, 38, 30, 29, 44, 34, 37, 47, 33, 29, 38, 33, 31, 35, 41, 43, 35, 29, 24, 19, 31, 41, 43, 50, 49, 48, 56, 51, 43, 28, 33, 37, 31, 38, 38, 42, 44, 40, 39, 31, 38, 48, 22, 25, 27, 24, 25, 29, 34, 38, 44, 45, 37, 39, 42, 37, 37, 31, 34, 30, 28, 31, 34, 32, 30, 31, 32, 32, 31, 32, 32, 30, 32, 32, 18, 21, 21, 24, 23, 26, 28, 25, 34, 39, 40, 39, 32, 29, 31, 27, 23, 22, 27, 27, 25, 24, 22, 22, 24, 27, 31, 29, 28, 23, 28, 31, 17, 15, 17, 21, 21, 19, 22, 24, 22, 22, 26, 24, 25, 25, 19, 18, 15, 20, 21, 18, 17, 15, 19, 19, 19, 24, 25, 24, 23, 24, 26, 25, 18, 10, 10, 15, 9, 9, 2, 6, 5, 0, 0, 0, 0, 3, 1, 2, 3, 3, 3, 8, 10, 18, 17, 18, 19, 22, 21, 19, 16, 15, 16, 18, 0, 2, 4, 8, 19, 20, 24, 18, 25, 29, 34, 38, 40, 32, 44, 54, 49, 29, 21, 11, 8, 4, 4, 3, 5, 13, 17, 13, 14, 14, 15, 19, 70, 82, 105, 110, 101, 124, 153, 149, 159, 175, 180, 170, 165, 188, 204, 234, 226, 217, 208, 179, 154, 133, 94, 56, 16, 6, 3, 2, 12, 16, 18, 17, 140, 136, 150, 162, 211, 229, 234, 239, 246, 244, 232, 240, 239, 244, 250, 250, 250, 250, 251, 250, 251, 251, 242, 235, 205, 158, 94, 33, 3, 0, 1, 15, 117, 105, 98, 108, 212, 232, 219, 218, 219, 217, 208, 213, 209, 238, 250, 251, 251, 251, 251, 252, 250, 246, 245, 247, 248, 245, 249, 216, 150, 59, 1, 0, 79, 74, 64, 69, 185, 220, 203, 207, 209, 209, 199, 198, 201, 235, 245, 244, 244, 247, 247, 247, 250, 250, 250, 250, 249, 240, 249, 241, 250, 241, 142, 34, 60, 69, 58, 67, 179, 205, 200, 197, 204, 207, 193, 202, 206, 227, 242, 242, 240, 224, 225, 241, 243, 238, 244, 250, 251, 251, 251, 252, 217, 211, 200, 160, 52, 59, 57, 62, 164, 197, 192, 186, 190, 195, 195, 197, 193, 222, 241, 233, 224, 212, 218, 221, 214, 203, 204, 201, 189, 186, 187, 187, 146, 142, 157, 164, 51, 51, 41, 48, 149, 190, 182, 186, 183, 185, 179, 177, 195, 221, 231, 221, 197, 148, 139, 130, 123, 103, 109, 125, 137, 163, 207, 142, 96, 126, 142, 170, 44, 43, 30, 46, 155, 185, 175, 188, 184, 181, 177, 183, 190, 205, 203, 178, 149, 102, 101, 119, 125, 137, 171, 197, 202, 218, 192, 105, 105, 132, 137, 139, 51, 53, 37, 58, 161, 187, 185, 181, 179, 175, 170, 163, 156, 163, 137, 132, 160, 184, 194, 203, 192, 195, 196, 185, 153, 133, 107, 97, 102, 105, 106, 116, 67, 74, 70, 72, 116, 134, 109, 104, 103, 88, 92, 89, 84, 86, 70, 116, 162, 167, 158, 129, 117, 107, 88, 64, 65, 73, 88, 82, 81, 92, 99, 119, 97, 102, 84, 78, 71, 68, 110, 137, 137, 131, 133, 142, 155, 140, 77, 69, 73, 59, 47, 40, 41, 46, 44, 58, 78, 79, 72, 67, 81, 92, 94, 115, 127, 102, 93, 109, 89, 98, 197, 208, 200, 204, 189, 173, 169, 146, 81, 54, 51, 50, 56, 62, 56, 59, 58, 65, 61, 65, 68, 72, 78, 79, 76, 91, 131, 112, 117, 116, 119, 128, 149, 150, 142, 129, 106, 100, 104, 91, 81, 80, 80, 80, 80, 73, 67, 62, 64, 68, 64, 59, 60, 68, 71, 69, 63, 65, 127, 130, 119, 121, 127, 119, 106, 100, 93, 82, 81, 91, 98, 98, 97, 96, 91, 90, 88, 82, 74, 69, 71, 71, 64, 63, 62, 67, 68, 64, 61, 65)
      for (i <- searchAreaData.indices) {
        dut.io.org_data_in(i).poke(searchAreaData(i).U)
      }

      dut.io.done_charge.poke(1.U)

      dut.clock.step(48)

      dut.io.min_sad.expect(0.U)
      dut.io.mvx_min.expect(1.S)
      dut.io.mvy_min.expect(1.S)
      dut.io.address_min.expect(233.U)

      dut.io.done_ldps.expect(1.U)
    }
  }
}